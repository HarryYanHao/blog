---
sidebar: 'auto'
sidebarDepth: 1
pageClass: common
---
# Nginx学习笔记
## Nginx 介绍
nginx是一款轻量级的Web服务器/反向代理服务器/电子邮件代理服务器。
nginx能做什么   

--web服务(动静分离)   
--负载均衡   
--正向代理   
--反向代理   

### 正向代理
客户没有能力直接访问目标地址，由中间有能力访问的服务器做代理，客户端访问这台服务器，服务器访问地址后将数据原样返回到客户端 eg：最典型的例子 翻墙。   
正向代理最大的特点 客户端明确的知道需要方位的服务器地址，服务器只清楚是哪台代理服务器，并不清楚具体是哪个客户端，正向代理模式隐藏了真实客户端信息。
对于服务器来说客户端是黑盒。   
正向代理配置示例
```
server {  
    resolver 114.114.114.114;       #指定DNS服务器IP地址  
    listen 8080;  
    location / {  
        proxy_pass http://$http_host$request_uri;     #设定代理服务器的协议和地址  
    }  
}  
```

### 反向代理
在分布式部署中，客户端访问反向代理服务器 由该服务器将请求转发到某一服务器上进行业务处理。此时请求来源的客户端信息是明确的，但是由哪个应用服务器处理是不明确的。
对于客户端来说处理业务的服务器是黑盒。   
反向代理配置示例 
```
#http块
upstream abc.harry.com{
	server 192.168.16.85:8882 weight=1;
	server 192.168.16.85:8883 weight=2;
}
#location块
location / {
	···
	proxy_pass http://abc.harry.com;
	···
}

```
### 负载均衡
负载均衡主要是针对反向代理。将反向代理服务器接收的请求按照规则分发的过程称为负载均衡，具体的规则称为负载均衡策略。具体的请求数量称为负载量。
nginx支持的负载均衡调度算法有以下五种   
1.`轮询`，默认情况   
2.`权重`，依据weight值 weight值越大被分配到请求的几率越大，这种主要是实际工作中后端服务器硬件配置不同而调整的，正常来说性能好分配的权重大，接收的请求多。   
3.`ip_hash`，每个请求的客户端ip的hash结果进行匹配。你这样的算法下固定了同一个ip访问到同一个后端服务器，这也解决了集群部署环境下session共享的问题。   
4.`fair（第三方）`，智能调度算法，动态的根据后端服务器的请求处理响应时间进行均衡分配，响应时间短处理效率高的分配到请求的概率高。需要注意的是nginx默认是不支持fair算法，需要安装upstream_fair模块。   
5.`url_hash(第三方)`，按照访问的url的hash结果分配请求。每个请求的url会指向后端固定的某个服务器，可以在nginx作为静态服务器的情况下提高缓存效率。同样要注意nginx默认不支持这种调度算法，需要安装。 

## Nginx 性能优化 
### Nginx 运行工作进程数量
nginx默认采用多进程工作方式，Nginx启动后会运行一个master进程和多个的worker进程，和配置的数量有关。master进程主要用来管理work进程。
1.接收来自外界的信号。    
2.向各worker进程发送信号。   
3.监控worker进程的运行状态。   
4.当异常情况下worker进程退出后，会自动重新启动新的worker进程。   
work进程主要用来处理网络事件，各个worker进程之间是对等且相互独立的。它们同等竞争来自客户端的请求，一个请求只可能在一个worker进程中处理，work进程看个数一般设置为机器CPU核数，如果设置过大，可能会因为上下文切换更加耗费时间，稳定性更低 没有达到优化的目的

### Nginx运行CPU亲和力
```
#nginx 配置
worker_processes 4;
worker_cpu_affinity 0001 0010 0100 1000;
```

### Nginx最大打开文件数
```
work_rlimit_nofile 65535;
```
这个配置是指当一个nginx进程打开的最多文件描述符数目，理论值是应该是最多打开文件数(ulimit -n)与nginx进程数相除，但是nginx分配请求不是那么均匀，所以最好与ulimit -n的值保持一致



