<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>laravel框架 | Harry&#39;s Blog</title>
    <meta name="description" content="生活，成长">
    
    
    <link rel="preload" href="/assets/css/0.styles.903a613d.css" as="style"><link rel="preload" href="/assets/js/app.b88cf943.js" as="script"><link rel="preload" href="/assets/js/2.70ce101a.js" as="script"><link rel="preload" href="/assets/js/18.f0eb0574.js" as="script"><link rel="prefetch" href="/assets/js/10.6e147cbe.js"><link rel="prefetch" href="/assets/js/11.9d519b98.js"><link rel="prefetch" href="/assets/js/12.8ae1faf9.js"><link rel="prefetch" href="/assets/js/13.4a7f650b.js"><link rel="prefetch" href="/assets/js/14.b9824abb.js"><link rel="prefetch" href="/assets/js/15.cce600e4.js"><link rel="prefetch" href="/assets/js/16.d6c9be22.js"><link rel="prefetch" href="/assets/js/17.5e03de55.js"><link rel="prefetch" href="/assets/js/19.a81cfd55.js"><link rel="prefetch" href="/assets/js/20.9fb79ef1.js"><link rel="prefetch" href="/assets/js/21.2de00f9c.js"><link rel="prefetch" href="/assets/js/22.25258ba7.js"><link rel="prefetch" href="/assets/js/23.e97f153c.js"><link rel="prefetch" href="/assets/js/3.09c1c532.js"><link rel="prefetch" href="/assets/js/4.8e23c845.js"><link rel="prefetch" href="/assets/js/5.4416394e.js"><link rel="prefetch" href="/assets/js/6.b72ecaf6.js"><link rel="prefetch" href="/assets/js/7.2cc40af8.js"><link rel="prefetch" href="/assets/js/8.61a7dd8d.js"><link rel="prefetch" href="/assets/js/9.307a2b00.js">
    <link rel="stylesheet" href="/assets/css/0.styles.903a613d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container common"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Harry's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/technical/" class="nav-link router-link-active">技术文档</a></div><div class="nav-item"><a href="/article/" class="nav-link">随笔</a></div><div class="nav-item"><a href="http://www.harry5.xyz/index/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  展示
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com//HarryYanHao" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/technical/" class="nav-link router-link-active">技术文档</a></div><div class="nav-item"><a href="/article/" class="nav-link">随笔</a></div><div class="nav-item"><a href="http://www.harry5.xyz/index/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  展示
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com//HarryYanHao" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>laravel框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/technical/laravel.html#依赖注入、控制反转、反射各个概念的理解和使用" class="sidebar-link">依赖注入、控制反转、反射各个概念的理解和使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/technical/laravel.html#简化流程" class="sidebar-link">简化流程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/technical/laravel.html#概念简述" class="sidebar-link">概念简述</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/technical/laravel.html#laravel源码分析" class="sidebar-link">laravel源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical/laravel.html#入口文件" class="sidebar-link">入口文件</a></li><li class="sidebar-sub-header"><a href="/technical/laravel.html#从入口文件延伸" class="sidebar-link">从入口文件延伸</a></li><li class="sidebar-sub-header"><a href="/technical/laravel.html#application类" class="sidebar-link">Application类</a></li><li class="sidebar-sub-header"><a href="/technical/laravel.html#kernel类" class="sidebar-link">kernel类</a></li><li class="sidebar-sub-header"><a href="/technical/laravel.html#管道流" class="sidebar-link">管道流</a></li></ul></li><li><a href="/technical/laravel.html#实践" class="sidebar-link">实践</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="laravel框架"><a href="#laravel框架" aria-hidden="true" class="header-anchor">#</a> laravel框架</h1> <p></p><div class="table-of-contents"><ul><li><a href="#依赖注入、控制反转、反射各个概念的理解和使用">依赖注入、控制反转、反射各个概念的理解和使用</a></li><li><a href="#简化流程">简化流程</a></li><li><a href="#概念简述">概念简述</a></li><li><a href="#laravel源码分析">laravel源码分析</a><ul><li><a href="#入口文件">入口文件</a></li><li><a href="#从入口文件延伸">从入口文件延伸</a></li><li><a href="#application类">Application类</a></li><li><a href="#kernel类">kernel类</a></li><li><a href="#管道流">管道流</a></li></ul></li><li><a href="#实践">实践</a></li></ul></div><p></p> <h2 id="依赖注入、控制反转、反射各个概念的理解和使用"><a href="#依赖注入、控制反转、反射各个概念的理解和使用" aria-hidden="true" class="header-anchor">#</a> 依赖注入、控制反转、反射各个概念的理解和使用</h2> <p><a href="https://laravelacademy.org/post/9782.html" target="_blank" rel="noopener noreferrer">https://laravelacademy.org/post/9782.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://laravelacademy.org/post/9783.html" target="_blank" rel="noopener noreferrer">https://laravelacademy.org/post/9783.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="简化流程"><a href="#简化流程" aria-hidden="true" class="header-anchor">#</a> 简化流程</h2> <p>index.php单文件入口 bootstrap下app.php实例化Application类 其中Application类继承容器类Container Container类中提供bind make build方法 容器中维护绑定数组，绑定数组由key值和闭包组成。app的绑定动作在构造函数中实例化时候完成，其余绑定动作由服务提供商类继承的服务提供基类的抽象方法register方法进行bind  框架基础会自动make（build）对应的对象，自定义容器内的绑定数组根据业务场景需要调用make（build）方法实例化对象。</p> <h2 id="概念简述"><a href="#概念简述" aria-hidden="true" class="header-anchor">#</a> 概念简述</h2> <p>bind：绑定数组key和闭包</p> <p>make：根据key 找到对应闭包 并执行该闭包 闭包内有build方法</p> <p>build：实例化，主要运用的方法是反射 根据绑定数组中的类名使用new ReflectionClass反射找到对应的类，由反射类获取构造函数getConstructor，获取构造函数的参数，利用递归实例化参数（创建依赖对象）实例化对象</p> <p>di：依赖注入，不在方法内部使用new 来创建对象，由构造方法，外部方法传入对象，达到代码解耦和开放封闭原则</p> <p>ioc：控制反转，不需要自己修改类中实例化的类，由外部传入实例化后的对象</p> <p>门面：使用静态方式 调用方法 实例化门面的基类 各个子类只返回需要实例化的key值 外部调用时调起基类中__callStatic的魔术方法 __callStatic调用make函数 生成对象后执行方法</p> <p>契约：实际上就是接口 使用interface定义接口方法 implements实现接口</p> <p>中间件：过滤进入web应用的Http请求，使用的设计模式主要是管道设计模式，该模式主要运用的函数是array_reduce和call_user_function 管道用数组的数据方式实现 根据管道里面的顺序 array_reduce生成对应的闭包 call_user_function调用执行</p> <h2 id="laravel源码分析"><a href="#laravel源码分析" aria-hidden="true" class="header-anchor">#</a> laravel源码分析</h2> <h3 id="入口文件"><a href="#入口文件" aria-hidden="true" class="header-anchor">#</a> 入口文件</h3> <div class="tip custom-block"><p>由于工作环境，这里用于源码分析的laravel版本是5.0</p></div> <p>laravel的单文件入口是<code>public/index.php</code>,我们先看一下这个文件的核心源码</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//index.php</span>
<span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">require_once</span> <span class="token constant">__DIR__</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'/../bootstrap/app.php'</span><span class="token punctuation">;</span>
<span class="token variable">$kernel</span> <span class="token operator">=</span> <span class="token variable">$app</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Illuminate\Contracts\Http\Kernel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$kernel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handle</span><span class="token punctuation">(</span>
	<span class="token variable">$request</span> <span class="token operator">=</span> Illuminate\<span class="token package">Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">capture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$response</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$kernel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以发现index.php主要的内容就是引入app.php文件和用上文提到的<code>make</code>方法示例化了laravel内核的对象，调用handle方法<a href="/technical/laravel.html#kernel类">HttpKernel</a> 随后返回Response对象， 最后执行一些中间件的terminate方法,扫尾工作。</p> <h3 id="从入口文件延伸"><a href="#从入口文件延伸" aria-hidden="true" class="header-anchor">#</a> 从入口文件延伸</h3> <p>接下来我们来看看<code>bootstrap\app.php</code>里面的内容</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Illuminate<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Application</span><span class="token punctuation">(</span>
	<span class="token function">realpath</span><span class="token punctuation">(</span><span class="token constant">__DIR__</span><span class="token punctuation">.</span><span class="token single-quoted-string string">'/../'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$app</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">singleton</span><span class="token punctuation">(</span>
	<span class="token single-quoted-string string">'Illuminate\Contracts\Http\Kernel'</span><span class="token punctuation">,</span>
	<span class="token single-quoted-string string">'App\Http\Kernel'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个文件主要作用是：<br>
1.实例化Application类，Application类继承了Container类所以实际上就是实例化了一个容器，容器也是实现依赖注入(di)和控制反转(ioc)的基础。
singleton可以看成是对bind方法的一个简单封装，实际的作用就是存储key和闭包到绑定数组中。<br>
2.把kernel类有写入了绑定数组当中</p> <h3 id="application类"><a href="#application类" aria-hidden="true" class="header-anchor">#</a> Application类</h3> <p>上面提到Application类是一个容器，其实不够准确，容器只是它的一部分功能，我们来看一下Application的构建函数</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$basePath</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">registerBaseBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">registerBaseServiceProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">registerCoreContainerAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$basePath</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setBasePath</span><span class="token punctuation">(</span><span class="token variable">$basePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>将自身的对象写入绑定数组当中，绑定路由，事件基本服务提供商</p> <h3 id="kernel类"><a href="#kernel类" aria-hidden="true" class="header-anchor">#</a> kernel类</h3> <p>这里需要主要看两个类<code>app/Http/kernel</code> 和 <code>vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php</code> laravel把后者取了别名为HttpKernel，后者是前者的基类。下面展示这两个类中主要的代码</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//app/Http/Kernel</span>
<span class="token keyword">class</span> <span class="token class-name">Kernel</span> <span class="token keyword">extends</span> <span class="token class-name">HttpKernel</span> <span class="token punctuation">{</span>
	<span class="token keyword">protected</span> <span class="token variable">$routeMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
		<span class="token single-quoted-string string">'auth'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'App\Http\Middleware\Authenticate'</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'auth.basic'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'Illuminate\Auth\Middleware\AuthenticateWithBasicAuth'</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'guest'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'App\Http\Middleware\RedirectIfAuthenticated'</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'auth.api'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'App\Http\Middleware\AuthenticateWithApi'</span><span class="token punctuation">,</span>
	<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">protected</span> <span class="token variable">$bootstrappers</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
		<span class="token single-quoted-string string">'Illuminate\Foundation\Bootstrap\DetectEnvironment'</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'Illuminate\Foundation\Bootstrap\LoadConfiguration'</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'Illuminate\Foundation\Bootstrap\ConfigureLogging'</span><span class="token punctuation">,</span>
		<span class="token comment">//'Illuminate\Foundation\Bootstrap\HandleExceptions',</span>
		<span class="token single-quoted-string string">'App\Exceptions\HandleExceptions'</span><span class="token punctuation">,</span> <span class="token comment">//自定义错误信息, 对于系统的notice之类的错误处理，error_code由0 转换为500</span>
		<span class="token single-quoted-string string">'Illuminate\Foundation\Bootstrap\RegisterFacades'</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'Illuminate\Foundation\Bootstrap\RegisterProviders'</span><span class="token punctuation">,</span>
		<span class="token single-quoted-string string">'Illuminate\Foundation\Bootstrap\BootProviders'</span><span class="token punctuation">,</span>
	<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//HttpKernel</span>
<span class="token keyword">class</span> <span class="token class-name">Kernel</span> <span class="token keyword">implements</span> <span class="token class-name">KernelContract</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>Application <span class="token variable">$app</span><span class="token punctuation">,</span> Router <span class="token variable">$router</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">app</span> <span class="token operator">=</span> <span class="token variable">$app</span><span class="token punctuation">;</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">router</span> <span class="token operator">=</span> <span class="token variable">$router</span><span class="token punctuation">;</span>

		<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">routeMiddleware</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$middleware</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token variable">$router</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$middleware</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">try</span>
		<span class="token punctuation">{</span>
			<span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">sendRequestThroughRouter</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">reportException</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">renderException</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">app</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'events'</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fire</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'kernel.handled'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Kernel</code>中主要定义了路由的中间件，以及定义了需要注入到绑定数组的类，对于这些需要绑定的类，laravel提供一个<code>Illuminate\Foundation\Bootstrap\RegisterProviders</code>注册类，统一将这些注册到绑定数组中，同时提供另外一个注册类<code>Illuminate\Foundation\Bootstrap\RegisterFacades</code>,统一注册门面。<br> <code>KernelHttp</code>主要关注构造方法和handle()方法
构造方法中的 <code>$router-&gt;middleware</code>  是将中间件配置写入路由类中的变量。用于管道构建中间件
<code>handle</code>方法的调用者是在入口文件<a href="/technical/laravel.html#入口文件">index.php</a><code>$response = $kernel-&gt;handle( 	$request = Illuminate\Http\Request::capture() );</code>这个方法处理的是启动注册类和初始化管道类。</p> <h3 id="管道流"><a href="#管道流" aria-hidden="true" class="header-anchor">#</a> 管道流</h3> <p>所谓管道（Pipeline）设计模式就是将会数据传递到一个任务序列中，管道扮演者流水线的角色，数据在这里被处理然后传递到下一个步骤。
管道中的每一个任务都会接受并返回同一类型的数据，这样子任务可以在管道中被添加、移除或者替换，而不影响其它子任务。<br>
Laravel 在框架中的很多地方用到了 Pipeline 设计模式，这意味着所有我们需要实现管道设计模式的地方已然是应用底层的一部分了，中间件便是利用管道流的思想编写的。我们来看一下管道类简化后具体实现的方法。</p> <div class="language-php extra-class"><pre class="language-php"><code>	<span class="token comment">//定义通过管道的对象</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token variable">$passable</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">passable</span> <span class="token operator">=</span> <span class="token variable">$passable</span><span class="token punctuation">;</span>
		
		<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//定义所需的管道</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">through</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">pipes</span> <span class="token operator">=</span> <span class="token variable">$pipes</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//具体执行管道</span>
	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//闭包的顺序是按照管道顺序从内到外，执行顺序相当于管道顺序的倒序，故要转换管道顺序，执行的顺序与定义的管道顺序一致</span>
		<span class="token variable">$pipes</span> <span class="token operator">=</span> <span class="token function">array_reverse</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">pipes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$call_back</span> <span class="token operator">=</span> <span class="token function">array_reduce</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$call_back</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">call_user_func</span><span class="token punctuation">(</span>
				<span class="token variable">$call_back</span><span class="token punctuation">,</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">passable</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

</code></pre></div><h2 id="实践"><a href="#实践" aria-hidden="true" class="header-anchor">#</a> 实践</h2> <p>仿造laravel的思想 自写框架
<a href="https://github.com/HarryYanHao/HF" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/27/2019, 4:04:46 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b88cf943.js" defer></script><script src="/assets/js/2.70ce101a.js" defer></script><script src="/assets/js/18.f0eb0574.js" defer></script>
  </body>
</html>
